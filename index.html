<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Markdown</title>
    <!-- libs -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

    <!-- Kontent Custom elements API-->
    <script src="https://app.devkontentmasters.com/js-api/custom-element/v1/custom-element.js"></script>

    <!-- Custom elements styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <!-- Custom element HTML -->
    <textarea id="editor"></textarea>
    <button id="select_asset">Select asset</button>

    <!-- Custom element code -->
    <script>
        var isDisabled = false;

        function updateDisabled(disabled) {
            if (disabled) {
                $(".disabled_overlay").show();
            }
            else {
                $(".disabled_overlay").hide();
            }
            updateSize();
            isDisabled = disabled;
        }

        function setup(value) {
            $("#select_asset").click(function (e) {
                alert("test alert")
                console.log("console log")
                insertImage();
            });
        }

        function updateSize() {
            // Updates the custom element height in the Kontent UI
            const height = Math.ceil($("html").height());
            CustomElement.setHeight(height);
        }

        function setValue(value) {
            // Sends updated value to Kontent (if the editor is empty, will send null  so the element won't meet a required condition).
            if (!isDisabled) {
                CustomElement.setValue(value || null);
            }
        }

        function initCustomElement() {
            try {
                CustomElement.init((element, _context) => {
                    setup(element.value);
                    updateSize();
                });

                // Reacts to changes in disabling (e.g., when publishing the item)
                CustomElement.onDisabledChanged(updateDisabled);
            } catch (err) {
                // Sends message to console and editor if initialization failed (for example, if the page is displayed outside the Kontent UI)
                console.error(err);
            }
        }

        initCustomElement();

        async function insertImage() {
            // Opens an asset selection dialog in Kontent
            const assets = await CustomElement.selectAssets({
                allowMultiple: false,
                fileType: 'images'
            });
            // Gets an ID of the first selected asset
            const assetId = assets[0].id;
            // Retrieves details of the asset specified by its ID
            const assetDetails = await CustomElement.getAssetDetails([assetId]);

            const cm = editorInstance.codemirror;
            const stat = editorInstance.getState(cm);
            // Specifies the text to insert into the editor after picking an asset
            const insertText = ["![", "](#url#)"];
            // Replaces #url# with the actual URL to the asset
            _replaceSelection(cm, stat.image, insertText, assetDetails[0].url);
        }

        function _replaceSelection(cm, active, startEnd, url) {
            var text;
            var start = startEnd[0];
            var end = startEnd[1];
            var startPoint = cm.getCursor("start");
            var endPoint = cm.getCursor("end");
            if (url) {
                end = end.replace("#url#", url);
            }
            if (active) {
                text = cm.getLine(startPoint.line);
                start = text.slice(0, startPoint.ch);
                end = text.slice(startPoint.ch);
                cm.replaceRange(start + end, {
                    line: startPoint.line,
                    ch: 0
                });
            } else {
                text = cm.getSelection();
                cm.replaceSelection(start + text + end);

                startPoint.ch += start.length;
                if (startPoint !== endPoint) {
                    endPoint.ch += start.length;
                }
            }
            cm.setSelection(startPoint, endPoint);
            cm.focus();
        }
    </script>
</body>

</html>